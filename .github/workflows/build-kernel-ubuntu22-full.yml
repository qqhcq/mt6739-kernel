name: Ubuntu 22.04 Full Speed Build (Complete Drivers)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
    - name: æ£€å‡ºä»£ç ï¼ˆæµ…å…‹éš†ï¼‰
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: å¿«é€Ÿæ¸…ç†ç£ç›˜
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY" /usr/local/lib/android &
        df -h
    
    - name: ç¼“å­˜ ccacheï¼ˆå…³é”®åŠ é€Ÿï¼‰
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-u22-full-${{ github.sha }}
        restore-keys: ccache-u22-full-
    
    - name: ç¼“å­˜å·¥å…·é“¾
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu
        key: toolchain-linaro-7.5.0
    
    - name: å®‰è£…ä¾èµ–ï¼ˆUbuntu 22.04 ä¼˜åŒ–ï¼‰
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          build-essential bc bison flex libssl-dev \
          libncurses-dev ccache wget ca-certificates \
          python3 python-is-python3 lz4 cpio
    
    - name: ä¸‹è½½å·¥å…·é“¾
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        wget -q https://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/aarch64-linux-gnu/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz
        tar xf gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz
        rm gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz
    
    - name: é…ç½® ccacheï¼ˆæœ€å¤§åŒ–ç¼“å­˜ï¼‰
      run: |
        ccache -M 3G
        ccache -z
        ccache --set-config=compression=true
        ccache --set-config=compression_level=1
    
    - name: é…ç½®å†…æ ¸ï¼ˆå®Œæ•´é©±åŠ¨ï¼‰
      run: |
        export PATH=$PWD/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin:$PATH
        export ARCH=arm64
        export CROSS_COMPILE="ccache aarch64-linux-gnu-"
        
        # æŸ¥æ‰¾é…ç½®
        CONFIG=$(find arch/arm64/configs -name "*6739*" -o -name "*k39tv1*" | head -1)
        [ -z "$CONFIG" ] && CONFIG=$(find arch/arm64/configs -name "*6763*" | head -1)
        [ -z "$CONFIG" ] && CONFIG="arch/arm64/configs/defconfig"
        
        echo "ä½¿ç”¨é…ç½®: $CONFIG"
        make -j$(nproc) $(basename $CONFIG)
        
        # åªç¦ç”¨ç­¾åç›¸å…³ï¼ˆé¿å… OpenSSL 3.x é—®é¢˜ï¼‰
        scripts/config --disable MODULE_SIG
        scripts/config --disable MODULE_SIG_ALL
        scripts/config --disable SYSTEM_TRUSTED_KEYRING
        scripts/config --disable SYSTEM_TRUSTED_KEYS
        
        # ç¦ç”¨è°ƒè¯•ä¿¡æ¯ï¼ˆå‡å°‘ç¼–è¯‘æ—¶é—´ï¼Œä¸å½±å“åŠŸèƒ½ï¼‰
        scripts/config --disable DEBUG_INFO
        scripts/config --disable DEBUG_INFO_DWARF4
        scripts/config --disable DEBUG_INFO_BTF
        scripts/config --disable GDB_SCRIPTS
        
        # å¯ç”¨ USB ACM
        scripts/config --enable USB_GADGET
        scripts/config --enable USB_CONFIGFS
        scripts/config --enable USB_CONFIGFS_ACM
        scripts/config --enable USB_F_ACM
        
        make -j$(nproc) olddefconfig
    
    - name: é«˜é€Ÿç¼–è¯‘ï¼ˆå®Œæ•´åŠŸèƒ½ + æ‰€æœ‰é©±åŠ¨ï¼‰
      run: |
        export PATH=$PWD/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin:$PATH
        export ARCH=arm64
        export CROSS_COMPILE="ccache aarch64-linux-gnu-"
        export KCFLAGS="-w -O2 -pipe -fno-stack-protector"
        export KCPPFLAGS="-w"
        
        # æœ€å¤§å¹¶è¡Œç¼–è¯‘
        JOBS=$(($(nproc) * 2))
        echo "=========================================="
        echo "ðŸš€ å¼€å§‹ç¼–è¯‘ - ä½¿ç”¨ $JOBS ä¸ªå¹¶è¡Œä»»åŠ¡"
        echo "=========================================="
        
        time make -j$JOBS Image.gz-dtb 2>&1 | tee build.log || \
        time make -j$JOBS Image.gz 2>&1 | tee build.log || \
        time make -j$JOBS Image 2>&1 | tee build.log
        
        echo "=========================================="
        echo "âœ… ç¼–è¯‘å®Œæˆ"
        echo "=========================================="
    
    - name: æ˜¾ç¤º ccache ç»Ÿè®¡
      run: |
        echo "=========================================="
        echo "ðŸ“Š ccache ç¼“å­˜ç»Ÿè®¡"
        echo "=========================================="
        ccache -s
    
    - name: æ£€æŸ¥ç¼–è¯‘ç»“æžœ
      id: check
      run: |
        if [ -f arch/arm64/boot/Image.gz-dtb ]; then
          KERNEL_FILE="arch/arm64/boot/Image.gz-dtb"
          KERNEL_NAME="Image.gz-dtb"
          echo "âœ… æ‰¾åˆ°: Image.gz-dtb"
        elif [ -f arch/arm64/boot/Image.gz ]; then
          KERNEL_FILE="arch/arm64/boot/Image.gz"
          KERNEL_NAME="Image.gz"
          echo "âœ… æ‰¾åˆ°: Image.gz"
        elif [ -f arch/arm64/boot/Image ]; then
          KERNEL_FILE="arch/arm64/boot/Image"
          KERNEL_NAME="Image"
          echo "âœ… æ‰¾åˆ°: Image"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"
          tail -n 100 build.log
          exit 1
        fi
        
        echo "KERNEL_FILE=$KERNEL_FILE" >> $GITHUB_ENV
        echo "KERNEL_NAME=$KERNEL_NAME" >> $GITHUB_ENV
        echo "success=true" >> $GITHUB_OUTPUT
        
        ls -lh $KERNEL_FILE
    
    - name: æ‰“åŒ…å‘å¸ƒ
      if: steps.check.outputs.success == 'true'
      run: |
        mkdir output
        cp $KERNEL_FILE output/kernel-mt6739-full.img
        cp .config output/kernel.config
        
        cat > output/BUILD_INFO.txt << EOF
        MT6739 å®Œæ•´å†…æ ¸ç¼–è¯‘ä¿¡æ¯
        ========================
        ç¼–è¯‘çŽ¯å¢ƒ: Ubuntu 22.04
        ç¼–è¯‘æ—¶é—´: $(date)
        Git Commit: ${{ github.sha }}
        å†…æ ¸ç‰ˆæœ¬: $(make kernelrelease)
        å·¥å…·é“¾: Linaro GCC 7.5.0
        
        ç‰¹æ€§:
        âœ… å®Œæ•´é©±åŠ¨ï¼ˆæœªåˆ å‡ä»»ä½•åŠŸèƒ½ï¼‰
        âœ… USB ACM ä¸²å£æ”¯æŒ
        âœ… æ‰€æœ‰éŸ³é¢‘/è§†é¢‘/ç½‘ç»œé©±åŠ¨
        âœ… ccache åŠ é€Ÿç¼–è¯‘
        
        é€‚ç”¨è®¾å¤‡: D22 å¯¹è®²æœº
        EOF
        
        echo "=========================================="
        echo "ðŸ“¦ æ‰“åŒ…å†…å®¹:"
        ls -lh output/
        echo "=========================================="
    
    - name: ä¸Šä¼ å†…æ ¸
      if: steps.check.outputs.success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-ubuntu22-full-${{ github.run_number }}
        path: output/*
        retention-days: 30
    
    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.run_number }}
        path: build.log
        retention-days: 7

