name: Build MT6739 Kernel (Power535) with ACM Support

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  TOOLCHAIN_VERSION: gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu
  KERNEL_ARCH: arm64
  DEFCONFIG: k39tv1_64_bsp_defconfig

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 120
    
    steps:
    - name: ğŸ“Š æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
      run: |
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        uname -a
        echo "=== CPU ä¿¡æ¯ ==="
        nproc
        echo "=== å†…å­˜ä¿¡æ¯ ==="
        free -h
        echo "=== ç£ç›˜ç©ºé—´ï¼ˆæ¸…ç†å‰ï¼‰==="
        df -h
        
    - name: ğŸ§¹ æœ€å¤§åŒ–æ„å»ºç©ºé—´
      run: |
        echo "æ­£åœ¨æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo apt-get clean
        echo "=== ç£ç›˜ç©ºé—´ï¼ˆæ¸…ç†åï¼‰==="
        df -h
        
    - name: ğŸ“¥ å…‹éš† Kernel æºç 
      run: |
        echo "æ­£åœ¨å…‹éš† MT6739 å†…æ ¸æºç ï¼ˆPower535 ç‰ˆæœ¬ï¼‰..."
        git clone --depth=1 https://github.com/Power535/android_kernel_common_MT6763.git kernel-src
        cd kernel-src
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        echo "=== æºç ç›®å½•ç»“æ„ ==="
        ls -lah
        echo "=== å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯ ==="
        head -n 5 Makefile
        echo "=== æ£€æŸ¥å¯ç”¨çš„ defconfig ==="
        find arch/arm64/configs -name "*6739*" -o -name "*6763*" | head -20
        
    - name: ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        echo "æ­£åœ¨å®‰è£…ç¼–è¯‘ä¾èµ–..."
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential \
          bc \
          bison \
          flex \
          libssl-dev \
          libncurses-dev \
          python3 \
          python3-pip \
          python-is-python3 \
          u-boot-tools \
          device-tree-compiler \
          lz4 \
          lzop \
          zip \
          unzip
        
        # æ˜¾ç¤º OpenSSL ç‰ˆæœ¬ï¼ˆubuntu-20.04 è‡ªå¸¦ OpenSSL 1.1ï¼Œå®Œç¾å…¼å®¹è€å†…æ ¸ï¼‰
        openssl version
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: ğŸ’¾ ç¼“å­˜äº¤å‰ç¼–è¯‘å·¥å…·é“¾
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: ${{ env.TOOLCHAIN_VERSION }}
        key: ${{ runner.os }}-toolchain-${{ env.TOOLCHAIN_VERSION }}
        
    - name: ğŸ“¦ ä¸‹è½½äº¤å‰ç¼–è¯‘å·¥å…·é“¾
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        echo "æ­£åœ¨ä¸‹è½½ Linaro GCC 7.5 å·¥å…·é“¾..."
        TOOLCHAIN_URL="https://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/aarch64-linux-gnu/${TOOLCHAIN_VERSION}.tar.xz"
        
        if wget --spider "$TOOLCHAIN_URL" 2>/dev/null; then
          wget --progress=dot:giga "$TOOLCHAIN_URL"
          echo "âœ… å·¥å…·é“¾ä¸‹è½½å®Œæˆ"
        else
          echo "âŒ å·¥å…·é“¾ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
    - name: ğŸ“‚ è§£å‹å·¥å…·é“¾
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        echo "æ­£åœ¨è§£å‹å·¥å…·é“¾..."
        tar -xf ${TOOLCHAIN_VERSION}.tar.xz
        echo "âœ… å·¥å…·é“¾è§£å‹å®Œæˆ"
        
    - name: ğŸ” éªŒè¯å·¥å…·é“¾
      run: |
        export PATH=$PWD/${TOOLCHAIN_VERSION}/bin:$PATH
        echo "TOOLCHAIN_PATH=$PWD/${TOOLCHAIN_VERSION}/bin/aarch64-linux-gnu-" >> $GITHUB_ENV
        
        echo "=== å·¥å…·é“¾ä¿¡æ¯ ==="
        ${TOOLCHAIN_VERSION}/bin/aarch64-linux-gnu-gcc --version
        echo "âœ… å·¥å…·é“¾éªŒè¯æˆåŠŸ"
        
    - name: ğŸ ä¿®å¤ Python 2/3 å…¼å®¹æ€§å’Œæƒé™
      run: |
        cd kernel-src
        
        echo "=== ä¿®å¤ Python å…¼å®¹æ€§å’Œæƒé™é—®é¢˜ ==="
        
        # 1. ä¿®å¤ tools/dct/DrvGen.pyï¼ˆPython 3 å…¼å®¹æ€§ + æ‰§è¡Œæƒé™ï¼‰
        if [ -f "tools/dct/DrvGen.py" ]; then
          echo "ä¿®å¤ tools/dct/DrvGen.py..."
          
          # ä¿®å¤ Python 2 åˆ° Python 3 çš„è¯­æ³•
          sed -i '1s|^#!/usr/bin/python.*|#!/usr/bin/env python3|' tools/dct/DrvGen.py
          sed -i 's/print /print(/g; s/^\([^#]*\)print(\(.*\))$/\1print(\2)/g' tools/dct/DrvGen.py
          
          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x tools/dct/DrvGen.py
          
          echo "âœ… DrvGen.py ä¿®å¤å®Œæˆï¼ˆè¯­æ³• + æƒé™ï¼‰"
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ° DrvGen.pyï¼Œè·³è¿‡"
        fi
        
        # 2. ä¿®å¤ drvgen.mkï¼Œè®©å®ƒä½¿ç”¨ python3 æ‰§è¡Œ
        if [ -f "scripts/drvgen/drvgen.mk" ]; then
          echo "ä¿®å¤ scripts/drvgen/drvgen.mk..."
          # å°† ./tools/dct/DrvGen.py æ›¿æ¢ä¸º python3 tools/dct/DrvGen.py
          sed -i 's|\./tools/dct/DrvGen\.py|python3 tools/dct/DrvGen.py|g' scripts/drvgen/drvgen.mk
          echo "âœ… drvgen.mk ä¿®å¤å®Œæˆ"
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ° drvgen.mkï¼Œè·³è¿‡"
        fi
        
        # 3. ç»™æ‰€æœ‰ Python è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
        echo "æ·»åŠ  Python è„šæœ¬æ‰§è¡Œæƒé™..."
        find tools -name "*.py" -exec chmod +x {} \; 2>/dev/null || true
        find scripts -name "*.py" -exec chmod +x {} \; 2>/dev/null || true
        echo "âœ… Python è„šæœ¬æƒé™è®¾ç½®å®Œæˆ"
        
        # 4. ä¿®å¤ DTC yylloc é‡å¤å®šä¹‰é—®é¢˜
        if [ -f "scripts/dtc/dtc-lexer.lex.c" ]; then
          echo "ä¿®å¤ DTC yylloc é‡å¤å®šä¹‰..."
          sed -i 's/^YYLTYPE yylloc;$/extern YYLTYPE yylloc;/' scripts/dtc/dtc-lexer.lex.c
          echo "âœ… DTC yylloc ä¿®å¤å®Œæˆ"
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ° dtc-lexer.lex.cï¼Œè·³è¿‡"
        fi
        
        echo ""
        echo "âœ… æ‰€æœ‰å…¼å®¹æ€§å’Œæƒé™é—®é¢˜ä¿®å¤å®Œæˆ"
        
    - name: âš™ï¸ é…ç½® Kernel
      run: |
        cd kernel-src
        
        # æŸ¥æ‰¾å¯ç”¨çš„ MT6739 defconfig
        echo "=== æŸ¥æ‰¾ MT6739 ç›¸å…³é…ç½® ==="
        AVAILABLE_CONFIGS=$(find arch/arm64/configs -name "*6739*" -o -name "*6763*" | head -10)
        echo "æ‰¾åˆ°çš„é…ç½®æ–‡ä»¶ï¼š"
        echo "$AVAILABLE_CONFIGS"
        
        # ä¼˜å…ˆä½¿ç”¨ MT6739 çš„é…ç½®ï¼Œå¦åˆ™ä½¿ç”¨ MT6763 çš„
        MT6739_CONFIG=$(find arch/arm64/configs -name "*6739*" | head -1)
        if [ -n "$MT6739_CONFIG" ]; then
          DEFCONFIG=$(basename "$MT6739_CONFIG")
          echo "âœ… ä½¿ç”¨ MT6739 ä¸“ç”¨é…ç½®: ${DEFCONFIG}"
        else
          # å°è¯•ä½¿ç”¨ MT6763 é…ç½®
          MT6763_CONFIG=$(find arch/arm64/configs -name "*6763*" | head -1)
          if [ -n "$MT6763_CONFIG" ]; then
            DEFCONFIG=$(basename "$MT6763_CONFIG")
            echo "âš ï¸ ä½¿ç”¨ MT6763 é…ç½®: ${DEFCONFIG}"
          else
            # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„é»˜è®¤é…ç½®
            echo "âš ï¸ ä½¿ç”¨é»˜è®¤é…ç½®: ${DEFCONFIG}"
          fi
        fi
        
        echo "=== åº”ç”¨é…ç½®: ${DEFCONFIG} ==="
        make ARCH=${KERNEL_ARCH} CROSS_COMPILE=${{ env.TOOLCHAIN_PATH }} ${DEFCONFIG}
        
        echo "=== åº”ç”¨æ—§é…ç½®é€‰é¡¹ ==="
        # ä½¿ç”¨éäº¤äº’å¼é…ç½®ï¼Œè‡ªåŠ¨é€‰æ‹©é»˜è®¤å€¼
        yes "" | make ARCH=${KERNEL_ARCH} CROSS_COMPILE=${{ env.TOOLCHAIN_PATH }} oldconfig 2>&1 | head -n 50
        
        echo "âœ… å†…æ ¸é…ç½®å®Œæˆ"
        
        # å¯ç”¨ USB ACM ä¸²å£æ”¯æŒ - ç›´æ¥ä¿®æ”¹ .config æ–‡ä»¶
        echo "=== å¯ç”¨ USB ä¸²å£æ”¯æŒ ==="
        
        # å¤‡ä»½åŸå§‹é…ç½®
        cp .config .config.backup
        
        # å®šä¹‰éœ€è¦å¯ç”¨çš„é…ç½®é€‰é¡¹
        USB_CONFIGS=(
          "CONFIG_USB_GADGET"
          "CONFIG_USB_CONFIGFS"
          "CONFIG_USB_F_ACM"
          "CONFIG_USB_F_SERIAL"
          "CONFIG_USB_G_SERIAL"
          "CONFIG_USB_SERIAL"
          "CONFIG_USB_ACM"
          "CONFIG_USB_F_OBEX"
          "CONFIG_USB_F_MTP"
          "CONFIG_USB_CONFIGFS_SERIAL"
          "CONFIG_USB_CONFIGFS_ACM"
          "CONFIG_USB_CONFIGFS_OBEX"
          "CONFIG_USB_CONFIGFS_F_FS"
          "CONFIG_USB_CONFIGFS_F_MTP"
          "CONFIG_USB_CONFIGFS_F_ACC"
        )
        
        # å¯ç”¨æ‰€æœ‰ USB ä¸²å£ç›¸å…³é…ç½®
        for config in "${USB_CONFIGS[@]}"; do
          # å¦‚æœé…ç½®é¡¹å­˜åœ¨ä½†æœªå¯ç”¨ï¼Œåˆ™å¯ç”¨å®ƒ
          if grep -q "^# ${config} is not set" .config; then
            sed -i "s/^# ${config} is not set/${config}=y/" .config
            echo "âœ… å¯ç”¨: ${config}"
          elif grep -q "^${config}=" .config; then
            # ç¡®ä¿æ˜¯ =y è€Œä¸æ˜¯ =m
            sed -i "s/^${config}=.*/${config}=y/" .config
            echo "âœ… å·²å­˜åœ¨: ${config}"
          else
            # é…ç½®é¡¹ä¸å­˜åœ¨ï¼Œç›´æ¥æ·»åŠ 
            echo "${config}=y" >> .config
            echo "â• æ·»åŠ : ${config}"
          fi
        done
        
        # é‡æ–°ç”Ÿæˆé…ç½®ï¼Œä½¿ä¾èµ–å…³ç³»æ­£ç¡®
        echo "=== é‡æ–°ç”Ÿæˆé…ç½® ==="
        yes "" | make ARCH=${KERNEL_ARCH} CROSS_COMPILE=${{ env.TOOLCHAIN_PATH }} oldconfig 2>&1 | head -n 30 || true
        
        # æ˜¾ç¤ºå…³é”®é…ç½®é€‰é¡¹
        echo ""
        echo "=== æœ€ç»ˆé…ç½®æ£€æŸ¥ ==="
        grep -E "CONFIG_USB_ACM|CONFIG_USB_GADGET|CONFIG_USB_CONFIGFS|CONFIG_USB_F_ACM|CONFIG_USB_SERIAL" .config | head -20 || echo "âš ï¸ æ³¨æ„: æŸäº› USB é…ç½®å¯èƒ½æœªå¯ç”¨"
        
    - name: ğŸ”¨ ç¼–è¯‘ Kernel
      run: |
        cd kernel-src
        
        echo "=== å¼€å§‹ç¼–è¯‘å†…æ ¸ ==="
        echo "ä½¿ç”¨ $(nproc) ä¸ª CPU æ ¸å¿ƒå¹¶è¡Œç¼–è¯‘"
        echo "å¼€å§‹æ—¶é—´: $(date)"
        
        # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
        touch build.log
        
        # è®¾ç½®ç¼–è¯‘å‚æ•°
        export ARCH=${KERNEL_ARCH}
        export CROSS_COMPILE=${{ env.TOOLCHAIN_PATH }}
        
        # å¿½ç•¥ OpenSSL åºŸå¼ƒè­¦å‘Šï¼ˆå…¼å®¹ OpenSSL 3.0ï¼‰
        export KCFLAGS="-Wno-deprecated-declarations -Wno-error=deprecated-declarations"
        export HOSTCFLAGS="-Wno-deprecated-declarations -Wno-error=deprecated-declarations"
        
        # ä¿®å¤ Makefile ä¸­çš„ OpenSSL ç¼–è¯‘é€‰é¡¹
        if grep -q "scripts/extract-cert" Makefile; then
          echo "ä¿®å¤ Makefile çš„ OpenSSL ç¼–è¯‘é€‰é¡¹..."
          sed -i '/HOSTCFLAGS_extract-cert/d' scripts/Makefile
          echo 'HOSTCFLAGS_extract-cert.o = -Wno-deprecated-declarations' >> scripts/Makefile
          echo "âœ… OpenSSL ç¼–è¯‘é€‰é¡¹ä¿®å¤å®Œæˆ"
        fi
        
        BUILD_SUCCESS=false
        
        # å°è¯•ç¼–è¯‘ Image.gz-dtbï¼ˆæœ€ç†æƒ³çš„æ ¼å¼ï¼šå‹ç¼©å†…æ ¸+è®¾å¤‡æ ‘ï¼‰
        echo ""
        echo ">>> å°è¯•ç¼–è¯‘ Image.gz-dtb..."
        if make -j$(nproc) Image.gz-dtb 2>&1 | tee build.log; then
          echo "âœ… Image.gz-dtb ç¼–è¯‘æˆåŠŸï¼"
          BUILD_SUCCESS=true
          KERNEL_TARGET="Image.gz-dtb"
        else
          echo "âš ï¸ Image.gz-dtb ç¼–è¯‘å¤±è´¥ï¼ˆå¯èƒ½æ­¤å†…æ ¸ä¸æ”¯æŒ dtbï¼‰ï¼Œå°è¯• Image..."
          
          # ä¸æ¸…ç†ï¼Œç›´æ¥å°è¯•ç¼–è¯‘ Imageï¼ˆæœªå‹ç¼©å†…æ ¸ï¼‰
          echo ""
          echo ">>> å°è¯•ç¼–è¯‘ Image..."
          if make -j$(nproc) Image 2>&1 | tee -a build.log; then
            echo "âœ… Image ç¼–è¯‘æˆåŠŸï¼"
            BUILD_SUCCESS=true
            KERNEL_TARGET="Image"
          else
            echo "âŒ Image ç¼–è¯‘ä¹Ÿå¤±è´¥äº†ï¼Œå°è¯•æœ€åŸºç¡€çš„ vmlinux..."
            
            # æœ€åå°è¯•åªç¼–è¯‘å†…æ ¸æœ¬èº«ï¼ˆæœ€åŸºç¡€æ ¼å¼ï¼‰
            echo ""
            echo ">>> æœ€åå°è¯•ç¼–è¯‘ vmlinux..."
            if make -j$(nproc) vmlinux 2>&1 | tee -a build.log; then
              echo "âœ… vmlinux ç¼–è¯‘æˆåŠŸï¼ˆéœ€è¦åç»­å¤„ç†ï¼‰"
              BUILD_SUCCESS=true
              KERNEL_TARGET="vmlinux"
            else
              echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•éƒ½å¤±è´¥äº†"
              BUILD_SUCCESS=false
            fi
          fi
        fi
        
        echo ""
        echo "ç»“æŸæ—¶é—´: $(date)"
        echo "ç¼–è¯‘ç›®æ ‡: ${KERNEL_TARGET:-æ— }"
        
        if [ "$BUILD_SUCCESS" != "true" ]; then
          echo ""
          echo "=== ç¼–è¯‘é”™è¯¯æ—¥å¿—ï¼ˆæœ€å 200 è¡Œï¼‰==="
          tail -n 200 build.log
          exit 1
        fi
        
    - name: âœ… æ£€æŸ¥ç¼–è¯‘äº§ç‰©
      run: |
        cd kernel-src
        
        echo "=== æ£€æŸ¥ç¼–è¯‘ç»“æœ ==="
        
        KERNEL_FOUND=false
        
        # æŒ‰ä¼˜å…ˆçº§æ£€æŸ¥å†…æ ¸æ–‡ä»¶
        if [ -f arch/arm64/boot/Image.gz-dtb ]; then
          echo "âœ… æ‰¾åˆ° Image.gz-dtb (æœ€ä½³é€‰æ‹©)"
          ls -lh arch/arm64/boot/Image.gz-dtb
          cp arch/arm64/boot/Image.gz-dtb kernel_image
          KERNEL_FOUND=true
          echo "KERNEL_TYPE=Image.gz-dtb" >> $GITHUB_ENV
          
        elif [ -f arch/arm64/boot/Image.gz ]; then
          echo "âœ… æ‰¾åˆ° Image.gz"
          ls -lh arch/arm64/boot/Image.gz
          cp arch/arm64/boot/Image.gz kernel_image
          KERNEL_FOUND=true
          echo "KERNEL_TYPE=Image.gz" >> $GITHUB_ENV
          
        elif [ -f arch/arm64/boot/Image ]; then
          echo "âœ… æ‰¾åˆ° Image"
          ls -lh arch/arm64/boot/Image
          cp arch/arm64/boot/Image kernel_image
          KERNEL_FOUND=true
          echo "KERNEL_TYPE=Image" >> $GITHUB_ENV
          
        elif [ -f vmlinux ]; then
          echo "âš ï¸ åªæ‰¾åˆ° vmlinux (éœ€è¦è¿›ä¸€æ­¥å¤„ç†)"
          ls -lh vmlinux
          cp vmlinux kernel_image
          KERNEL_FOUND=true
          echo "KERNEL_TYPE=vmlinux" >> $GITHUB_ENV
        fi
        
        if [ "$KERNEL_FOUND" != "true" ]; then
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å†…æ ¸æ–‡ä»¶"
          echo "=== æ£€æŸ¥ boot ç›®å½• ==="
          ls -lR arch/arm64/boot/ || true
          echo "=== ç¼–è¯‘æ—¥å¿—ï¼ˆæœ€å 100 è¡Œï¼‰==="
          tail -n 100 build.log
          exit 1
        fi
        
        # è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
        echo "=== å†…æ ¸æ–‡ä»¶ä¿¡æ¯ ==="
        file kernel_image
        sha256sum kernel_image
        
    - name: ğŸ“¤ ä¸Šä¼  Kernel é•œåƒ
      uses: actions/upload-artifact@v4
      with:
        name: mt6739-kernel-acm-${{ env.KERNEL_TYPE }}
        path: kernel-src/kernel_image
        retention-days: 30
        compression-level: 0
        
    - name: ğŸ“‹ ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.run_number }}
        path: kernel-src/build.log
        retention-days: 7
        
    - name: ğŸ“Š ç”Ÿæˆæ„å»ºæ‘˜è¦
      if: always()
      run: |
        cd kernel-src
        
        echo "## ğŸ”§ MT6739 å†…æ ¸ç¼–è¯‘æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ„å»ºç¼–å·:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**æäº¤ SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "kernel_image" ]; then
          echo "### âœ… ç¼–è¯‘æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å†…æ ¸ç±»å‹:** \`${KERNEL_TYPE:-æœªçŸ¥}\`" >> $GITHUB_STEP_SUMMARY
          echo "**æ–‡ä»¶å¤§å°:** $(du -h kernel_image | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "åœ¨ Actions é¡µé¢çš„ Artifacts ä¸­ä¸‹è½½ç¼–è¯‘å¥½çš„å†…æ ¸" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ ç¼–è¯‘å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—äº†è§£è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ğŸ‰ åˆ›å»º Release
      if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0-power535-build-${{ github.run_number }}
        name: MT6739 Kernel (Power535/MT6763) with ACM - Build ${{ github.run_number }}
        body: |
          ## ğŸ“± MT6739 Kernel (Power535 ç‰ˆæœ¬) with USB ACM Support
          
          > åŸºäº Power535/android_kernel_common_MT6763 ä»“åº“ç¼–è¯‘
          > æ”¯æŒ MT6580/MT6737/MT6739/MT6750/MT6757c/MT6761/MT6762/MT6763
          
          ### ğŸ“‹ æ„å»ºä¿¡æ¯
          - **æ„å»ºç¼–å·:** ${{ github.run_number }}
          - **æ„å»ºæ—¶é—´:** ${{ github.event.head_commit.timestamp }}
          - **æäº¤ SHA:** `${{ github.sha }}`
          - **å†…æ ¸ç±»å‹:** `${{ env.KERNEL_TYPE }}`
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          - âœ… **USB ACM (Serial) Support** - æ”¯æŒ USB ä¸²å£é€šä¿¡
          - âœ… **USB ADB Support** - Android è°ƒè¯•æ¡¥æ”¯æŒ
          - âœ… **USB MTP Support** - åª’ä½“ä¼ è¾“åè®®æ”¯æŒ
          - âœ… **USB Gadget** - USB è®¾å¤‡æ¨¡å¼æ”¯æŒ
          
          ### ğŸ”§ é€‚ç”¨è®¾å¤‡
          - MT6739 èŠ¯ç‰‡ç»„è®¾å¤‡
          - TCL 5059D åŠåŒç±»è®¾å¤‡
          - å’Œå¯¹è®² D22 å¯¹è®²æœº
          
          ### ğŸ“– ä½¿ç”¨æ–¹æ³•
          
          #### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ AIK (Android Image Kitchen)
          ```bash
          # 1. è§£åŒ…åŸ boot.img
          ./unpackimg.sh boot.img
          
          # 2. æ›¿æ¢å†…æ ¸
          cp kernel_image split_img/boot.img-kernel
          
          # 3. é‡æ–°æ‰“åŒ…
          ./repackimg.sh
          
          # 4. åˆ·å…¥è®¾å¤‡
          fastboot flash boot image-new.img
          ```
          
          #### æ–¹æ³•äºŒï¼šä½¿ç”¨ Magisk
          ```bash
          # 1. åœ¨ Magisk Manager ä¸­é€‰æ‹©å®‰è£…
          # 2. é€‰æ‹©å¹¶ä¿®è¡¥ boot.img
          # 3. åˆ·å…¥ä¿®è¡¥åçš„é•œåƒ
          ```
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·æœºå‰è¯·å¤‡ä»½åŸ boot.img
          - ç¡®è®¤è®¾å¤‡å‹å·åŒ¹é…
          - å»ºè®®åœ¨ recovery æ¨¡å¼ä¸‹åˆ·å…¥
          - é¦–æ¬¡åˆ·å…¥å¯èƒ½éœ€è¦æ¸…é™¤ç¼“å­˜
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [æºç ä»“åº“](https://github.com/Power535/android_kernel_common_MT6763)
          - [æ„å»ºæ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          **è‡ªåŠ¨æ„å»ºäº GitHub Actions** ğŸ¤–
          
        files: kernel-src/kernel_image
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
