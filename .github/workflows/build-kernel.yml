name: Build MT6739 Kernel with ACM Support

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  TOOLCHAIN_VERSION: gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu
  KERNEL_ARCH: arm64
  DEFCONFIG: k39tv1_64_bsp_defconfig

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 120
    
    steps:
    - name: ğŸ“Š æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
      run: |
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        uname -a
        echo "=== CPU ä¿¡æ¯ ==="
        nproc
        echo "=== å†…å­˜ä¿¡æ¯ ==="
        free -h
        echo "=== ç£ç›˜ç©ºé—´ï¼ˆæ¸…ç†å‰ï¼‰==="
        df -h
        
    - name: ğŸ§¹ æœ€å¤§åŒ–æ„å»ºç©ºé—´
      run: |
        echo "æ­£åœ¨æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo apt-get clean
        echo "=== ç£ç›˜ç©ºé—´ï¼ˆæ¸…ç†åï¼‰==="
        df -h
        
    - name: ğŸ“¥ å…‹éš† Kernel æºç 
      run: |
        echo "æ­£åœ¨å…‹éš† MT6739 å†…æ ¸æºç ..."
        git clone --depth=1 https://github.com/5059d/kernel_5059d_mt6739_tcl.git
        cd kernel_5059d_mt6739_tcl/kernel-4.4
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        echo "=== æºç ç›®å½•ç»“æ„ ==="
        ls -lah
        echo "=== å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯ ==="
        head -n 5 Makefile
        
    - name: ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        echo "æ­£åœ¨å®‰è£…ç¼–è¯‘ä¾èµ–..."
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential \
          bc \
          bison \
          flex \
          libssl-dev \
          libncurses-dev \
          python3 \
          python3-pip \
          python-is-python3 \
          u-boot-tools \
          device-tree-compiler \
          lz4 \
          lzop \
          zip \
          unzip
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: ğŸ’¾ ç¼“å­˜äº¤å‰ç¼–è¯‘å·¥å…·é“¾
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: ${{ env.TOOLCHAIN_VERSION }}
        key: ${{ runner.os }}-toolchain-${{ env.TOOLCHAIN_VERSION }}
        
    - name: ğŸ“¦ ä¸‹è½½äº¤å‰ç¼–è¯‘å·¥å…·é“¾
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        echo "æ­£åœ¨ä¸‹è½½ Linaro GCC 7.5 å·¥å…·é“¾..."
        TOOLCHAIN_URL="https://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/aarch64-linux-gnu/${TOOLCHAIN_VERSION}.tar.xz"
        
        if wget --spider "$TOOLCHAIN_URL" 2>/dev/null; then
          wget --progress=dot:giga "$TOOLCHAIN_URL"
          echo "âœ… å·¥å…·é“¾ä¸‹è½½å®Œæˆ"
        else
          echo "âŒ å·¥å…·é“¾ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
    - name: ğŸ“‚ è§£å‹å·¥å…·é“¾
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        echo "æ­£åœ¨è§£å‹å·¥å…·é“¾..."
        tar -xf ${TOOLCHAIN_VERSION}.tar.xz
        echo "âœ… å·¥å…·é“¾è§£å‹å®Œæˆ"
        
    - name: ğŸ” éªŒè¯å·¥å…·é“¾
      run: |
        export PATH=$PWD/${TOOLCHAIN_VERSION}/bin:$PATH
        echo "TOOLCHAIN_PATH=$PWD/${TOOLCHAIN_VERSION}/bin/aarch64-linux-gnu-" >> $GITHUB_ENV
        
        echo "=== å·¥å…·é“¾ä¿¡æ¯ ==="
        ${TOOLCHAIN_VERSION}/bin/aarch64-linux-gnu-gcc --version
        echo "âœ… å·¥å…·é“¾éªŒè¯æˆåŠŸ"
        
    - name: ğŸ ä¿®å¤ Python 2/3 å…¼å®¹æ€§
      run: |
        cd kernel_5059d_mt6739_tcl/kernel-4.4
        
        echo "=== ä¿®å¤ Python å…¼å®¹æ€§é—®é¢˜ ==="
        
        # ä¿®å¤ tools/dct/DrvGen.py
        if [ -f "tools/dct/DrvGen.py" ]; then
          echo "ä¿®å¤ tools/dct/DrvGen.py..."
          
          # åˆ›å»º Python 3 å…¼å®¹çš„è¡¥ä¸è„šæœ¬
          cat > /tmp/fix_drvgen.py <<'PYTHON_SCRIPT'
import sys
import re

with open('tools/dct/DrvGen.py', 'r', encoding='utf-8', errors='ignore') as f:
    content = f.read()

# åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ  cmp å‡½æ•°ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if 'def cmp(a, b):' not in content:
    cmp_func = '''def cmp(a, b):
    return (a > b) - (a < b)

'''
    # åœ¨ç¬¬ä¸€ä¸ª import æˆ– def ä¹‹å‰æ’å…¥
    if 'import ' in content:
        content = cmp_func + content
    else:
        first_def = content.find('def ')
        if first_def != -1:
            content = content[:first_def] + cmp_func + content[first_def:]

# ä¿®å¤ print è¯­å¥ä¸º print å‡½æ•°
content = re.sub(r"print\s+'([^']*)'", r"print('\1')", content)
content = re.sub(r'print\s+"([^"]*)"', r'print("\1")', content)

# ä¿å­˜ä¿®å¤åçš„æ–‡ä»¶
with open('tools/dct/DrvGen.py', 'w', encoding='utf-8') as f:
    f.write(content)

print("âœ… DrvGen.py ä¿®å¤å®Œæˆ")
PYTHON_SCRIPT
          
          python3 /tmp/fix_drvgen.py
        fi
        
        # ä¿®å¤ DTC yylloc é‡å¤å®šä¹‰é—®é¢˜
        if [ -f "scripts/dtc/dtc-lexer.lex.c" ]; then
          echo "ä¿®å¤ DTC yylloc é‡å¤å®šä¹‰..."
          sed -i 's/^YYLTYPE yylloc;$/extern YYLTYPE yylloc;/' scripts/dtc/dtc-lexer.lex.c
          echo "âœ… DTC yylloc ä¿®å¤å®Œæˆ"
        fi
        
        echo "âœ… æ‰€æœ‰å…¼å®¹æ€§é—®é¢˜ä¿®å¤å®Œæˆ"
        
    - name: âš™ï¸ é…ç½® Kernel
      run: |
        cd kernel_5059d_mt6739_tcl/kernel-4.4
        
        echo "=== ä½¿ç”¨é»˜è®¤é…ç½®: ${DEFCONFIG} ==="
        make ARCH=${KERNEL_ARCH} CROSS_COMPILE=${{ env.TOOLCHAIN_PATH }} ${DEFCONFIG}
        
        echo "=== åº”ç”¨æ—§é…ç½®é€‰é¡¹ ==="
        # ä½¿ç”¨éäº¤äº’å¼é…ç½®ï¼Œè‡ªåŠ¨é€‰æ‹©é»˜è®¤å€¼
        yes "" | make ARCH=${KERNEL_ARCH} CROSS_COMPILE=${{ env.TOOLCHAIN_PATH }} oldconfig 2>&1 | head -n 50
        
        echo "âœ… å†…æ ¸é…ç½®å®Œæˆ"
        
        # æ˜¾ç¤ºå…³é”®é…ç½®é€‰é¡¹
        echo "=== å…³é”®é…ç½®æ£€æŸ¥ ==="
        grep -E "CONFIG_USB_ACM|CONFIG_USB_GADGET|CONFIG_USB_CONFIGFS" .config || echo "æ³¨æ„: æŸäº› USB é…ç½®å¯èƒ½æœªå¯ç”¨"
        
    - name: ğŸ”¨ ç¼–è¯‘ Kernel
      run: |
        cd kernel_5059d_mt6739_tcl/kernel-4.4
        
        echo "=== å¼€å§‹ç¼–è¯‘å†…æ ¸ ==="
        echo "ä½¿ç”¨ $(nproc) ä¸ª CPU æ ¸å¿ƒå¹¶è¡Œç¼–è¯‘"
        echo "å¼€å§‹æ—¶é—´: $(date)"
        
        # ç¼–è¯‘å†…æ ¸é•œåƒ
        if make ARCH=${KERNEL_ARCH} \
                CROSS_COMPILE=${{ env.TOOLCHAIN_PATH }} \
                -j$(nproc) \
                Image 2>&1 | tee build.log; then
          echo "âœ… Image ç¼–è¯‘æˆåŠŸ"
          BUILD_SUCCESS=true
        else
          echo "âš ï¸ Image ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ç¼–è¯‘ vmlinux"
          if make ARCH=${KERNEL_ARCH} \
                  CROSS_COMPILE=${{ env.TOOLCHAIN_PATH }} \
                  -j$(nproc) \
                  vmlinux 2>&1 | tee -a build.log; then
            echo "âœ… vmlinux ç¼–è¯‘æˆåŠŸ"
            BUILD_SUCCESS=true
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            BUILD_SUCCESS=false
          fi
        fi
        
        echo "ç»“æŸæ—¶é—´: $(date)"
        
        if [ "$BUILD_SUCCESS" != "true" ]; then
          echo "=== ç¼–è¯‘é”™è¯¯æ—¥å¿—ï¼ˆæœ€å 100 è¡Œï¼‰==="
          tail -n 100 build.log
          exit 1
        fi
        
    - name: âœ… æ£€æŸ¥ç¼–è¯‘äº§ç‰©
      run: |
        cd kernel_5059d_mt6739_tcl/kernel-4.4
        
        echo "=== æ£€æŸ¥ç¼–è¯‘ç»“æœ ==="
        
        KERNEL_FOUND=false
        
        # æŒ‰ä¼˜å…ˆçº§æ£€æŸ¥å†…æ ¸æ–‡ä»¶
        if [ -f arch/arm64/boot/Image.gz-dtb ]; then
          echo "âœ… æ‰¾åˆ° Image.gz-dtb (æœ€ä½³é€‰æ‹©)"
          ls -lh arch/arm64/boot/Image.gz-dtb
          cp arch/arm64/boot/Image.gz-dtb ../kernel_image
          KERNEL_FOUND=true
          echo "KERNEL_TYPE=Image.gz-dtb" >> $GITHUB_ENV
          
        elif [ -f arch/arm64/boot/Image.gz ]; then
          echo "âœ… æ‰¾åˆ° Image.gz"
          ls -lh arch/arm64/boot/Image.gz
          cp arch/arm64/boot/Image.gz ../kernel_image
          KERNEL_FOUND=true
          echo "KERNEL_TYPE=Image.gz" >> $GITHUB_ENV
          
        elif [ -f arch/arm64/boot/Image ]; then
          echo "âœ… æ‰¾åˆ° Image"
          ls -lh arch/arm64/boot/Image
          cp arch/arm64/boot/Image ../kernel_image
          KERNEL_FOUND=true
          echo "KERNEL_TYPE=Image" >> $GITHUB_ENV
          
        elif [ -f vmlinux ]; then
          echo "âš ï¸ åªæ‰¾åˆ° vmlinux (éœ€è¦è¿›ä¸€æ­¥å¤„ç†)"
          ls -lh vmlinux
          cp vmlinux ../kernel_image
          KERNEL_FOUND=true
          echo "KERNEL_TYPE=vmlinux" >> $GITHUB_ENV
        fi
        
        if [ "$KERNEL_FOUND" != "true" ]; then
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å†…æ ¸æ–‡ä»¶"
          echo "=== æ£€æŸ¥ boot ç›®å½• ==="
          ls -lR arch/arm64/boot/ || true
          echo "=== ç¼–è¯‘æ—¥å¿—ï¼ˆæœ€å 100 è¡Œï¼‰==="
          tail -n 100 build.log
          exit 1
        fi
        
        # è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
        echo "=== å†…æ ¸æ–‡ä»¶ä¿¡æ¯ ==="
        file ../kernel_image
        sha256sum ../kernel_image
        
    - name: ğŸ“¤ ä¸Šä¼  Kernel é•œåƒ
      uses: actions/upload-artifact@v4
      with:
        name: mt6739-kernel-acm-${{ env.KERNEL_TYPE }}
        path: kernel_5059d_mt6739_tcl/kernel_image
        retention-days: 30
        compression-level: 0
        
    - name: ğŸ“‹ ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.run_number }}
        path: kernel_5059d_mt6739_tcl/kernel-4.4/build.log
        retention-days: 7
        
    - name: ğŸ“Š ç”Ÿæˆæ„å»ºæ‘˜è¦
      if: always()
      run: |
        cd kernel_5059d_mt6739_tcl/kernel-4.4
        
        echo "## ğŸ”§ MT6739 å†…æ ¸ç¼–è¯‘æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ„å»ºç¼–å·:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**æäº¤ SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "../kernel_image" ]; then
          echo "### âœ… ç¼–è¯‘æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å†…æ ¸ç±»å‹:** \`${KERNEL_TYPE:-æœªçŸ¥}\`" >> $GITHUB_STEP_SUMMARY
          echo "**æ–‡ä»¶å¤§å°:** $(du -h ../kernel_image | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "åœ¨ Actions é¡µé¢çš„ Artifacts ä¸­ä¸‹è½½ç¼–è¯‘å¥½çš„å†…æ ¸" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ ç¼–è¯‘å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—äº†è§£è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ğŸ‰ åˆ›å»º Release
      if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0-build-${{ github.run_number }}
        name: MT6739 Kernel with ACM - Build ${{ github.run_number }}
        body: |
          ## ğŸ“± MT6739 Kernel with USB ACM Support
          
          ### ğŸ“‹ æ„å»ºä¿¡æ¯
          - **æ„å»ºç¼–å·:** ${{ github.run_number }}
          - **æ„å»ºæ—¶é—´:** ${{ github.event.head_commit.timestamp }}
          - **æäº¤ SHA:** `${{ github.sha }}`
          - **å†…æ ¸ç±»å‹:** `${{ env.KERNEL_TYPE }}`
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          - âœ… **USB ACM (Serial) Support** - æ”¯æŒ USB ä¸²å£é€šä¿¡
          - âœ… **USB ADB Support** - Android è°ƒè¯•æ¡¥æ”¯æŒ
          - âœ… **USB MTP Support** - åª’ä½“ä¼ è¾“åè®®æ”¯æŒ
          - âœ… **USB Gadget** - USB è®¾å¤‡æ¨¡å¼æ”¯æŒ
          
          ### ğŸ”§ é€‚ç”¨è®¾å¤‡
          - MT6739 èŠ¯ç‰‡ç»„è®¾å¤‡
          - TCL 5059D åŠåŒç±»è®¾å¤‡
          - å’Œå¯¹è®² D22 å¯¹è®²æœº
          
          ### ğŸ“– ä½¿ç”¨æ–¹æ³•
          
          #### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ AIK (Android Image Kitchen)
          ```bash
          # 1. è§£åŒ…åŸ boot.img
          ./unpackimg.sh boot.img
          
          # 2. æ›¿æ¢å†…æ ¸
          cp kernel_image split_img/boot.img-kernel
          
          # 3. é‡æ–°æ‰“åŒ…
          ./repackimg.sh
          
          # 4. åˆ·å…¥è®¾å¤‡
          fastboot flash boot image-new.img
          ```
          
          #### æ–¹æ³•äºŒï¼šä½¿ç”¨ Magisk
          ```bash
          # 1. åœ¨ Magisk Manager ä¸­é€‰æ‹©å®‰è£…
          # 2. é€‰æ‹©å¹¶ä¿®è¡¥ boot.img
          # 3. åˆ·å…¥ä¿®è¡¥åçš„é•œåƒ
          ```
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·æœºå‰è¯·å¤‡ä»½åŸ boot.img
          - ç¡®è®¤è®¾å¤‡å‹å·åŒ¹é…
          - å»ºè®®åœ¨ recovery æ¨¡å¼ä¸‹åˆ·å…¥
          - é¦–æ¬¡åˆ·å…¥å¯èƒ½éœ€è¦æ¸…é™¤ç¼“å­˜
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [æºç ä»“åº“](https://github.com/5059d/kernel_5059d_mt6739_tcl)
          - [æ„å»ºæ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          **è‡ªåŠ¨æ„å»ºäº GitHub Actions** ğŸ¤–
          
        files: kernel_5059d_mt6739_tcl/kernel_image
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
